name: Tests, linting, etc.
on:
  push:
    branches:
      - "main"
      - "feature/*"
      - "hotfix/*"
      - "release/*"
  pull_request:

env:
  PYTHON_VERSIONS: 3.8 3.9 3.10 3.11 3.12 3.13

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  linters:
    runs-on: ubuntu-latest
    steps:
      - name: Cache Snaps
        id: cache-snaps
        uses: actions/cache@v4
        with:
          path: /var/lib/snapd/snaps
          key: ${{ runner.os }}-snaps
      - name: Begin async installations
        run: |
          sudo snap install --no-wait --classic pyright
          sudo snap install --no-wait shellcheck
          sudo snap install --no-wait --classic astral-uv
          sudo snap install --no-wait ruff
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Configure environment
        run: |
          echo "::group::Wait for snap to complete"
          snap watch --last=install
          echo "::endgroup::"
          sudo snap alias astral-uv.uv uv
          echo "::group::Change permissions for snaps for caching"
          sudo chmod a+r /var/lib/snapd/snaps/*.snap
          echo "::endgroup::"
      - name: Run Linters
        run: |
          make lint
  tests:
    strategy:
      matrix:
        platform: [ubuntu-latest, macos-latest, windows-latest]
      fail-fast: false
    runs-on: ${{ matrix.platform }}
    steps:
      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Test across all Python versions
        run: |
          for python_version in $PYTHON_VERSIONS; do
            make test UV_PYTHON=$python_version
          done
        env:
          PYTEST_ADDOPTS: "--no-header -vv -rN"
      - name: Test with the lowest supported libraries
        run: |
          for python_version in $PYTHON_VERSIONS; do
            make test UV_PYTHON=$python_version UV_RESOLUTION=lowest
          done
      - name: Upload code coverage
        uses: codecov/codecov-action@v5
        with:
          directory: ./results/
          files: coverage*.xml
      - name: Upload test results
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.platform }}
          path: results/
