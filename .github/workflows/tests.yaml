name: Tests, linting, etc.
on:
  push:
    branches:
      - "main"
      - "feature/*"
      - "hotfix/*"
      - "release/*"
  pull_request:

jobs:
  linters:
    runs-on: ubuntu-latest
    steps:
      - name: Begin async installations
        run: |
          sudo snap install --no-wait --classic pyright
          sudo snap install --no-wait shellcheck
          sudo snap install --no-wait --classic astral-uv
          sudo snap install --no-wait ruff
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      - name: Configure environment
        run: |
          echo "::group::Wait for snap to complete"
          snap watch --last=install
          echo "::endgroup::"
          sudo snap alias astral-uv.uv uv
      - name: Run Linters
        run: |
          make lint
  tests:
    strategy:
      matrix:
        platform: [ubuntu-20.04, ubuntu-22.04, ubuntu-24.04]
        python:
          - 3.8
          - 3.9
          - 3.10
          - 3.11
          - 3.12
          - 3.13-dev
    runs-on: ${{ matrix.platform }}
    steps:
      - name: Begin async install
        run: |
          sudo snap install --no-wait astral-uv
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Python ${{ matrix.python }} on ${{ matrix.platform }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python }}
          cache: 'pip'
      - name: Complete install
        run: |
          snap watch --last=install
          sudo snap alias astral-uv.uv uv
      - name: Test
        run: |
          make test-oldest
          make test
        env:
          PYTEST_ADDOPTS: "--no-header -vv -rN"
      - name: Upload code coverage
        uses: codecov/codecov-action@v3
        with:
          directory: ./results/
          files: coverage*.xml
      - name: Upload test results
        if: success() || failure()
        uses: actions/upload-artifact@v3
        with:
          name: test-results-${{ matrix.platform }}
          path: results/
